
List of notes while I try to fix move generation.

- First fix initial move generation of all other pieces.
  - Fact that you get 20 in the initial position is really a coincidence.
  - This was partly caused by me copying the bishop atks into the rook positions. Pawn moves are screwed up.
- Looks like a pawn is turning into a knight after the first move, why is this?
  - Had to do with the way that I was handling promotions. Promotions were happening where they shouldn't.
- Looks like things are being detected as pinned when they shouldn't be
- Move generation for pinned pawns might not work as it should. Specifically black pawns.
- Theat generation is slightly off.
  - Problem was kings moves not being added to threat mask.
  - Threat generation is still cooked.
    - Wait no I think its good
- **Pinned piece generation is very off.**
  - May have fixed it. Might still be broken though.
- Move generation
- Captures are broken.
  - Looks like the problem is with unmake.
- Kings are being duplicated, this might be a sign that kings are being taken.
  - Wasn't a sign that kings were being taken. Problem with gpu\_write\_piece().
- Problem with generating moves out of check.
  - Looks like a problem with double pawn pushes. Wouldn't be the first time that I've seen that.
  - Problem was that a double pawn push can block a check even if the single pawn push doesn't.
- More problems with duplicating pieces.
  - Pawn takes queen seems to be the root of a lot of the trouble.
  - Problem was that gpu\_make deleted ptype instead of cap\_ptype on capture.
- Problems with pins.
  - Simple error: used sq instead of UINT64\_C << sq in ray generation.
- Problems with enpassant.
  - Looks like this is twofold. There are problems with making the move and updating state and detection.
  - Detection is fixed now.
  - Looks like it was an issue where the board state wasn't being written on make.
- Castling is definetly broken.
  - 0 1 1 1 0 0 1 1 - Saw this in the state. Black queen enpassant has decayed for some reason.
  - Probably related to 3 lines above, maybe fixed? First castle is at depth 7, black castle at 8.
- Looks like there is an issue with writing CB\_PTYPE\_EMPTY to the bitboard again.
  - Seems to have something to do with a capture of a queen and a write to square 31?
  - This one's funny. A pinned pawn has special move generation. This move generation was bugged and allowed a pawn push to take the queen.
- Probelm with pinned pawn taking its pinner.
  - This was an error with the ray generation.
- Looks like there's an error with making rook moves decay the wrong castle rights.
  - This was not an error with the decay function. It was an error with board state tracking.
- Sigh... Another error with pieces being written to the baotd.
  - Looks like this one is when a pawn promotes with a capture.
  - I foolishly stated that PROMOS are sequential in the lowest 3 bits, and added the lowest 3 bits to the piece type to compute the new ptype.
  - This is wront, it should have been the lowest two bits.
  - Similar problem with capture detection. Incorrect check for capture promos.
